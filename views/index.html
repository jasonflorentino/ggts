{{ block "index" . }}
<!DOCTYPE html>
<html lang="en">
<head>
    <title>{{ .GGTS_TITLE }}</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="See GO Train schedules quickly and easily">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸš†</text></svg>" />
    <script src="https://unpkg.com/htmx.org@2.0.3" integrity="sha384-0895/pl2MU10Hqc6jd4RvrthNlDiE9U1tWmX7WRESftEDRosgxNsQG/Ze9YMRzHq" crossorigin="anonymous"></script>
    <link href="style.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Overpass:wght@100..900&display=swap" rel="stylesheet">
</head>
<body class="bg-stone-900 text-green-200 selection:bg-green-300 selection:text-green-900">
    <header class="p-2 sm:p-4 border-b-2 border-green-200 bg-green-600">
        <a href="{{ .GGTS_URL }}">
            <h1 class="text-2xl pt-1 text-green-100 font-bold sm:text-3xl md:text-4xl">ðŸš† GoGoTrainSchedule</h1>
        </a>
    </header>

    <main class="p-4 min-h-svh">
        <form class="flex flex-col gap-4 mt-2 sm:mt-4 md:mt-6 ">
            <div class="flex gap-4 flex-col sm:flex-row">
                <div class="flex items-center w-full">
                    <label for="fromStop" class="block min-w-12 md:text-lg">From</label>
                    {{ template "selectFrom" . }}
                </div>
                <div class="flex items-center w-full">
                    <label for="toStop" class="block min-w-12 md:text-lg drop-shadow-md">To</label>
                    {{ template "selectTo" . }}
                </div>
            </div>
            <div id="dateBox" class="flex items-center w-full hidden">
                <label for="date" class="block min-w-12 md:text-lg drop-shadow-md">Date</label>
                {{ template "datePicker" . }}
            </div>
        </form>
    

        <div class="fixed bottom-6 left-4 z-10 sm:bottom-8 sm:left-auto sm:right-6 lg:bottom-10 lg:right-8 flex gap-2">
            {{ template "otherway" . }}
            {{ template "dateToggle" }}
        </div>
    
        <section class="mt-4 sm:mt-6 md:mt-8">
            {{ template "timetable" . }}
        </section>
    </main>
    
    {{ template "footer" . }}

    <script>
        let interval;
        
        document.addEventListener("DOMContentLoaded", (event) => {
            updateTimeToDepart();
            interval = setInterval(updateTimeToDepart, 1000 * 5);
            
            document.body.addEventListener("htmx:beforeSwap", (evt) => {
                if (evt.detail.xhr.status === 422) {
                    evt.detail.shouldSwap = true;
                    evt.detail.isError = false;
                }
            })
            document.body.addEventListener("htmx:afterSwap", (evt) => {
                if (evt.detail.target.id === "timetable") {
                    clearInterval(interval);
                    updateTimeToDepart();
                    interval = setInterval(updateTimeToDepart, 1000 * 5);
                }
            })
        })

        function updateTimeToDepart() {
            const allTimeLefts = Array.from(document.querySelectorAll('.timeToDepart'));
            allTimeLefts.forEach((el) => {
                const now = Date.now();
                const end = new Date(el.dataset.zeroTime).getTime();
                const min = Math.floor((end - now) / 1000 / 60);
                const hrs = Math.floor(min / 60);
                el.innerText = `(${hrs > 0 ? hrs + "h" : ""  }${min - (hrs * 60)}m)`;
            })
        }

        function toggleDatePicker() {
            const dateBox = document.getElementById('dateBox');
            const dateToggle= document.getElementById('dateToggle');
            dateBox.classList.toggle('hidden');
            dateToggle.classList.toggle('bg-gray-600');
            dateToggle.classList.toggle('bg-green-600');
        }
    </script>
</body>
</html>
{{ end }}

{{ block "datePicker" . }}
    <div id="datePicker" class="flex gap-2 w-full">
        <select
            name="month"
            id="month"
            class="p-3 block h-12 md:h-14 rounded text-lg font-medium md:text-2xl w-full text-green-200 border border-stone-600 bg-stone-950 focus:outline-none focus:ring-2 focus:ring-green-500"
        >
            <option value="01">January</option>
            <option value="02">February</option>
            <option value="03">March</option>
            <option value="04">April</option>
            <option value="05">May</option>
            <option value="06">June</option>
            <option value="07">July</option>
            <option value="08">August</option>
            <option value="09">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
        </select>
        <select
            name="day"
            id="day"
            class="p-3 block h-12 md:h-14 rounded text-lg font-medium md:text-2xl w-full text-green-200 border border-stone-600 bg-stone-950 focus:outline-none focus:ring-2 focus:ring-green-500"
        >
            <option value="01">1</option>
            <option value="02">2</option>
            <option value="03">3</option>
            <option value="04">4</option>
            <option value="05">5</option>
            <option value="06">6</option>
            <option value="07">7</option>
        </select>
        <select
            name="year"
            id="year"
            class="p-3 block h-12 md:h-14 rounded text-lg font-medium md:text-2xl w-full text-green-200 border border-stone-600 bg-stone-950 focus:outline-none focus:ring-2 focus:ring-green-500"
        >
            <option value="2024">2024</option>
            <option value="2025">2025</option>
        </select>
    </div>
{{ end }}

{{ block "otherway" . }}
    <div id="otherway" hx-swap-oob="true">
        {{ if .To.Code }}
            <a href="/?from={{ .To.Code }}&to={{ .From.Code }}" class="block pb-2 pt-3 px-3 text-green-100 text-base sm:text-lg font-medium rounded-full bg-green-600">
                <span class="hidden sm:inline-block sm:pr-0.5">ðŸ”„</span>
                Other Way
            </a>
        {{ end }}
    </div>
{{ end }}

{{ block "dateToggle" . }}
    <div>
        <button id="dateToggle" onclick="toggleDatePicker()" class="pb-2 pt-3 px-3 text-green-100 text-base sm:text-lg font-medium rounded-full bg-gray-600">
            <span class="hidden sm:inline-block sm:pr-0.5">ðŸ“…</span>
            Date
        </button>
    </div>
{{ end }}

{{ block "destinationOption" . }}
    <option value="{{ .Code }}" {{ if .X_isSelected }}selected{{ end }}>{{ .Name }}</option>
{{ end }}

{{ block "selectFrom" . }}
<select 
    hx-get="/to"
    hx-target="#toStop"
    hx-swap="outerHTML"
    hx-include="#toStop"
    hx-select-oob="#timetable"
    id="fromStop"
    name="from" 
    class="p-3 block h-12 md:h-14 rounded text-lg font-medium md:text-2xl w-full text-blue-200 border border-stone-600 bg-stone-950 focus:outline-none focus:ring-2 focus:ring-green-500"
>
	{{ range .DestinationsFrom }}
		{{ template "destinationOption" . }}
	{{ end}}
</select>
{{ end }}

{{ block "selectTo" . }}
<select 
    hx-get="/trips"
    hx-target="#timetable"
    hx-swap="outerHTML"
    hx-include="#fromStop"
    name="to" 
    id="toStop"
    class="p-3 block h-12 md:h-14 rounded text-lg font-medium md:text-2xl w-full text-red-200 border border-stone-600 bg-stone-950 focus:outline-none focus:ring-2 focus:ring-green-500"
>
	{{ range .DestinationsTo }}
		{{ template "destinationOption" . }}
	{{ end}}
</select>
{{ end }}

{{ block "timetable" . }}
<div id="timetable">
<div class="flex gap-2 items-baseline"> 
    <h2 class="text-xl text-green-300 font-bold sm:text-2xl md:text-3xl">Trips</h2>
    {{ if .Timetable.X_DateDisplay }}
        <span class="ml-auto md:ml-0">{{ .Timetable.ServiceName }} â€“ <span class="font-medium">{{ .Timetable.X_DateDisplay }}</span></span>
    {{ end }}
</div>
<div  class="mt-2">
    <ol>
	{{ range .Timetable.Trips }}
		{{ template "trip" . }}
    {{ else }}
        <li class="flex justify-center p-4">
            <p class="text-lg">No results</p>
        </li>
	{{ end }}
    </ol>
</div>
</div>
{{ end }}

{{ block "trip" . }}
<li class="border-t border-green-100 grid grid-cols-7 sm:grid-cols-3 gap-2 pt-1 pb-5">
    <div class="flex flex-col col-span-3 sm:col-span-1">
        <span class="text-xs md:text-sm text-blue-200 uppercase opacity-80 font-medium">Departs</span>
        <span class="text-xl font-medium sm:text-2xl md:text-3xl">{{ .DepartureTimeDisplay }} <span class="timeToDepart animate-pulse text-base font-normal" data-zero-time="{{ .OrderTime }}"></span></span>
    </div>
    <div class="flex flex-col col-span-2 sm:col-span-1">
        <span class="text-xs md:text-sm text-green-300 uppercase opacity-80 font-medium">Travels</span>
        <span class="text-xl font-medium sm:text-2xl md:text-3xl">{{ .Duration }}</span>
    </div>
    <div class="flex flex-col col-span-2 sm:col-span-1 items-end sm:items-start">
        <span class="text-xs md:text-sm text-red-200 uppercase opacity-80 font-medium">Arrives</span>
        <span class="text-xl font-medium sm:text-2xl md:text-3xl">{{ .ArrivalTimeDisplay }}</span>
    </div>
</li>
{{ end }}

{{ block "footer" . }}
<footer class="p-6 bg-stone-950 flex flex-col gap-2 justify-center items-end sm:items-center text-sm md:text-base text-gray-400">
    <p>Made with ðŸ’š in Hamilton</p>
    <p>View source or file an issue on <a href="https://github.com/jasonflorentino/ggts/" target="_blank" rel="noreferrer" class="underline text-green-300">GitHub</a></p>
    <p>Not affiliated with <a href="https://www.gotransit.com/" target="_blank" rel="noreferrer" class="underline text-green-300">GO Transit</a></p>
</footer>
{{ end }}